# Implementation Plan

## Task Summary

本実装計画は、JWT認証システムの完全な実装タスクを定義します。バックエンド（Hono）とフロントエンド（React）を独立して開発可能な構成とし、並列実行可能なタスクには`(P)`マーカーを付与しています。

**タスク構成**:
- 合計 7 主要タスク
- 合計 31 サブタスク
- 全 8 要件グループをカバー
- 平均サブタスクサイズ: 1-3時間

**並列実行戦略**:
- バックエンドとフロントエンドは独立して並列実行可能
- 依存関係のないコンポーネント間は並列開発可能
- `(P)`マーカー付きタスクは同時実行可
- 統合タスクは全実装完了後に実行

---

## Tasks

### 1. プロジェクトセットアップと依存関係のインストール

- [x] 1.1 (P) バックエンドパッケージに必要な依存関係を追加
  - `jose`ライブラリのインストール（JWT署名・検証用）
  - 環境変数管理のための設定確認
  - TypeScript型定義の確認
  - _Requirements: 8.1, 8.5_

- [x] 1.2 (P) フロントエンドパッケージに必要な依存関係を追加
  - `jose`ライブラリのインストール（JWTデコード用）
  - React Router v6のインストール
  - TypeScript型定義の確認
  - _Requirements: 8.1, 8.5_

- [x] 1.3 (P) 環境変数の設定ファイル作成
  - `.env.example`ファイルをバックエンドパッケージに作成
  - JWT署名鍵（`JWT_SECRET`）のプレースホルダー設定
  - ポート番号設定（3001）の確認
  - _Requirements: 8.4, 8.5_

- [x] 1.4 (P) CORS設定の準備
  - フロントエンドのオリジン（http://localhost:5173）を確認
  - バックエンドでのCORS設定計画
  - credentials: true の設定確認
  - _Requirements: 8.3, 8.4_

---

### 2. バックエンド認証サービスの実装

- [x] 2.1 (P) AuthServiceの基本構造とJWT署名・検証機能の実装
  - ユーザー認証ロジック（ハードコードユーザー: demo/password）
  - `jose`を使用したJWT署名機能（HS256アルゴリズム）
  - Access Token生成（有効期限15分）
  - Refresh Token生成（有効期限7日）
  - JWTペイロード構造の定義（sub, username, exp, iat）
  - 環境変数からの署名鍵取得と起動時検証
  - _Requirements: 1.2, 1.4, 1.5_

- [x] 2.2 (P) AuthServiceのトークン検証機能の実装
  - `jose`を使用したAccess Token検証機能
  - Refresh Tokenからの新しいAccess Token発行機能
  - トークン期限切れ検証
  - トークン無効性検証
  - エラーハンドリング（TokenExpiredError, InvalidTokenError, AuthenticationError）
  - _Requirements: 2.2, 2.4, 3.2_

---

### 3. バックエンドAPIエンドポイントの実装

- [x] 3.1 バックエンドの基礎設定（CORS, エラーハンドリング）
  - Honoアプリの初期化
  - CORS middlewareの設定（origin, credentials）
  - グローバルエラーハンドリングの実装
  - レスポンス型定義（ErrorResponse）
  - _Requirements: 8.4_

- [x] 3.2 ログインエンドポイント（POST /auth/login）の実装
  - リクエストボディの検証（username, password必須）
  - AuthServiceによる認証処理
  - Access TokenのJSONレスポンス
  - Refresh TokenのHttpOnly Cookie設定（SameSite=Strict, Secure, Max-Age=604800）
  - エラーハンドリング（400, 401, 500）
  - _Requirements: 1.1, 1.2, 1.3_
  - _Note: 3.1完了後に実装可能_

- [x] 3.3 トークン更新エンドポイント（POST /auth/refresh）の実装
  - CookieからRefresh Token取得
  - AuthServiceによるトークン検証と新Access Token発行
  - JSONレスポンスの返却
  - エラーハンドリング（401, 500）
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - _Note: 3.1完了後に実装可能_

- [ ] 3.4 JWT認証ミドルウェアの実装
  - `Authorization: Bearer <token>`ヘッダーからトークン抽出
  - AuthServiceによるトークン検証
  - 検証成功時のコンテキストへのユーザー情報設定
  - 検証失敗時の401レスポンス返却
  - _Requirements: 3.2, 3.3, 3.4_
  - _Note: 2.2完了後に実装可能_

- [ ] 3.5 保護エンドポイント（GET /api/protected）の実装
  - JWT認証ミドルウェアの適用
  - コンテキストからユーザー情報取得
  - 保護データのJSONレスポンス返却
  - タイムスタンプ付きレスポンス
  - _Requirements: 3.1_
  - _Note: 3.4完了後に実装可能_

---

### 4. フロントエンド認証コンテキストの実装

- [ ] 4.1 (P) AuthContextとProviderの実装
  - React Context APIの設定
  - 認証状態管理（isAuthenticated, user, accessToken）
  - ログイン関数の実装（POST /auth/login呼び出し）
  - ログアウト関数の実装（状態クリア）
  - リフレッシュ関数の実装（POST /auth/refresh呼び出し）
  - アプリ起動時の自動リフレッシュ処理
  - 同時リフレッシュ防止フラグ
  - _Requirements: 4.3, 4.4, 5.2, 5.3, 5.4_

- [ ] 4.2 (P) useAuthカスタムフックの実装
  - AuthContextへのアクセスを提供
  - 型安全なコンテキスト取得
  - Context未設定時のエラーハンドリング
  - _Requirements: 4.3, 5.4_

---

### 5. フロントエンドAPIクライアントの実装

- [ ] 5.1 (P) apiClientユーティリティの実装
  - fetchラッパー関数の作成
  - `Authorization: Bearer <token>`ヘッダーの自動付与
  - 401レスポンス時の自動リフレッシュ＆リトライ
  - デバッグモード時のログ出力
  - CORS対応（credentials: 'include'）
  - 無限リフレッシュループ防止ロジック
  - TypeScript型定義（ApiClient, ApiClientConfig）
  - _Requirements: 5.1, 5.2, 7.3_

---

### 6. フロントエンドUIコンポーネントの実装

- [ ] 6.1 (P) LoginFormコンポーネントの実装
  - ユーザー名・パスワード入力フィールド
  - ログインボタンとフォーム送信処理
  - useAuthフックでのログイン関数呼び出し
  - ローディング状態の表示
  - エラーメッセージの表示
  - フロントエンドバリデーション（空欄チェック）
  - ログイン成功時のリダイレクト処理
  - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [ ] 6.2 (P) ProtectedRouteコンポーネントの実装
  - useAuthフックで認証状態取得
  - 未認証時のログインページへのリダイレクト
  - 認証済み時の子コンポーネントレンダリング
  - React Router v6の`<Navigate>`使用
  - _Requirements: 6.4_

- [ ] 6.3 (P) ProtectedPageコンポーネントの実装
  - useEffectでのマウント時データ取得
  - `/api/protected`エンドポイント呼び出し
  - ロード中状態の表示
  - エラー状態の表示
  - 取得データの画面表示
  - APIレスポンスの型検証
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 6.4 (P) TokenDebugPanelコンポーネントの実装
  - useAuthフックでAccess Token取得
  - `jose`の`decodeJwt()`でペイロードデコード
  - Access Token有効期限の表示
  - JWTペイロード内容の表示
  - デバッグモードフラグでの表示制御
  - 視覚的に分かりやすいUI
  - _Requirements: 7.1, 7.2_

---

### 7. ルーティングと統合

- [ ] 7.1 React Routerのセットアップとルート定義
  - React Router v6の設定
  - ログインページ（`/login`）ルート
  - 保護ページ（`/protected`）ルート
  - ProtectedRouteでの保護ページラップ
  - デフォルトルートのリダイレクト設定
  - _Requirements: 6.4_
  - _Note: 6.1, 6.2, 6.3完了後に実装可能_

- [ ] 7.2 AuthProviderのアプリへの統合
  - AuthProviderでのアプリ全体ラップ
  - ルーティング階層の適切な配置
  - 初期化順序の確認
  - _Requirements: 4.4, 5.3_
  - _Note: 4.1, 4.2, 7.1完了後に実装可能_

- [ ] 7.3 フロントエンドとバックエンドの統合動作確認
  - ログインフロー全体の動作確認
  - トークンリフレッシュフローの動作確認
  - 保護リソースアクセスの動作確認
  - ログアウトフローの動作確認
  - Cookie設定とヘッダー送信の確認
  - CORS動作の確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3_
  - _Note: 全実装タスク完了後に実行_

- [ ] 7.4 ページリフレッシュ時の認証状態復元の動作確認
  - ページリフレッシュ（F5）実行
  - アプリ起動時の自動リフレッシュ動作確認
  - Access Token復元の確認
  - Refresh Token期限切れ時のリダイレクト確認
  - _Requirements: 5.2, 5.3_
  - _Note: 7.3完了後に実行_

- [ ] 7.5 TokenDebugPanelの統合と表示確認
  - TokenDebugPanelの適切なページへの配置
  - デバッグモードフラグの設定方法確認
  - ペイロード表示の正確性確認
  - 有効期限表示の正確性確認
  - _Requirements: 7.1, 7.2_
  - _Note: 6.4完了後に実行_

---

## Task Dependencies

### 並列実行可能グループ
**グループ1: セットアップ（並列可）**
- 1.1, 1.2, 1.3, 1.4

**グループ2: バックエンド基盤（並列可）**
- 2.1, 2.2

**グループ3: フロントエンド基盤（並列可、バックエンド不要）**
- 4.1, 4.2, 5.1, 6.1, 6.2, 6.3, 6.4

**グループ4: バックエンドエンドポイント（3.1完了後）**
- 3.2, 3.3は3.1完了後に並列実行可
- 3.4は2.2完了後に実行可
- 3.5は3.4完了後に実行可

**グループ5: 統合（全実装完了後）**
- 7.1 → 7.2 → 7.3 → 7.4, 7.5（7.4と7.5は並列可）

### 推奨実行順序

**フェーズ1: セットアップ（並列）**
```
1.1, 1.2, 1.3, 1.4
```

**フェーズ2: コア実装（並列）**
```
バックエンド: 2.1, 2.2 → 3.1 → 3.2, 3.3, 3.4 → 3.5
フロントエンド: 4.1, 4.2, 5.1, 6.1, 6.2, 6.3, 6.4
```

**フェーズ3: 統合（順次）**
```
7.1 → 7.2 → 7.3 → (7.4, 7.5)
```

---

## Requirements Coverage

全8要件グループ（1-8）、全40要件をカバー:

| 要件 | カバーするタスク |
|------|------------------|
| 1.1 | 3.2, 7.3 |
| 1.2 | 2.1, 3.2, 7.3 |
| 1.3 | 3.2, 7.3 |
| 1.4 | 2.1, 7.3 |
| 1.5 | 2.1, 7.3 |
| 2.1 | 3.3, 7.3 |
| 2.2 | 2.2, 3.3, 7.3 |
| 2.3 | 3.3, 7.3 |
| 2.4 | 2.2, 3.3, 7.3 |
| 3.1 | 3.5, 7.3 |
| 3.2 | 2.2, 3.4, 7.3 |
| 3.3 | 3.4, 7.3 |
| 3.4 | 3.4, 7.3 |
| 4.1 | 6.1, 7.3 |
| 4.2 | 6.1, 7.3 |
| 4.3 | 4.1, 4.2, 6.1, 7.3 |
| 4.4 | 4.1, 7.2, 7.3 |
| 4.5 | 6.1, 7.3 |
| 5.1 | 5.1, 7.3 |
| 5.2 | 4.1, 5.1, 7.3, 7.4 |
| 5.3 | 4.1, 7.2, 7.3, 7.4 |
| 5.4 | 4.1, 4.2, 7.3 |
| 6.1 | 6.3, 7.3 |
| 6.2 | 6.3, 7.3 |
| 6.3 | 6.3, 7.3 |
| 6.4 | 6.2, 7.1, 7.3 |
| 7.1 | 6.4, 7.5 |
| 7.2 | 6.4, 7.5 |
| 7.3 | 5.1 |
| 8.1 | 1.1, 1.2 |
| 8.2 | （既存スクリプトで満たされる） |
| 8.3 | 1.4 |
| 8.4 | 1.3, 3.1 |
| 8.5 | 1.1, 1.2, 1.3 |

**要件カバレッジ: 100%**

---

## Notes

- **型安全性**: 全TypeScript実装で`any`使用禁止、design.mdのインターフェース定義に準拠
- **セキュリティ**: 学習用途のため、パスワード平文保存、ハードコードユーザー使用
- **テスト**: 本タスクリストはコード実装に焦点。テストは別途実装可能
- **エラーハンドリング**: 各タスクでエラーハンドリング実装必須
- **デバッグ**: TokenDebugPanelとapiClientログで学習支援を提供
